<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<title>æ¾æœ¬å¸‚ ã‚¬ã‚¹ç®¡æ¤œç´¢ãƒãƒƒãƒ—</title>

<link rel="stylesheet" href="css/leaflet.css">
<link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
<link rel="stylesheet" href="css/qgis2web.css">
<link rel="stylesheet" href="css/fontawesome-all.min.css">
<link rel="stylesheet" href="css/leaflet.photon.css">

<style>
html, body, #map {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
}
#title {
  position: absolute;
  top: 10px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255, 255, 255);
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 20px;
  font-weight: bold;
  color: #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  z-index: 1000;
  border: 1px solid #ccc;
}
#legend {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: rgba(255, 255, 255);
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 14px;
  color: #333;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  z-index: 1000;
  border: 1px solid #ccc;
}
#legend h4 {
  margin: 0 0 5px;
  font-size: 16px;
  font-weight: bold;
}
#legend div {
  display: flex;
  align-items: center;
  margin: 4px 0;
}
#legend span {
  display: inline-block;
  width: 18px;
  height: 18px;
  margin-right: 8px;
  border: 1px solid #777;
}
#tiban-search {
  position: absolute;
  top: 80px; 
  left: 10px;
  z-index: 1000;
  background: rgba(255,255,255);
  border-radius: 8px;
  width: 415px;
  padding: 6px;
  box-sizing: border-box;
}
#tiban-input {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  box-sizing: border-box;
}
#tiban-list {
  list-style: none;
  padding: 4px 0;
  margin: 6px 0 0 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch; 
  touch-action: pan-y; 
  max-height: calc(50vh);
  min-height: 0;
}

/* ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
.leaflet-control-custom {
  position: absolute;
  bottom: 20px;
  left: 10px;
  background: white;
  padding: 5px;
  border-radius: 6px;
  box-shadow: 0 0 4px rgba(0,0,0,0.4);
  z-index: 1000;
  cursor: move;
  transition: transform 0.2s ease;
}
.leaflet-control-custom button {
  width: 36px;
  height: 36px;
  margin: 2px;
  font-size: 18px;
  cursor: pointer;
}
.leaflet-control-custom .pan-buttons {
  text-align: center;
  margin-bottom: 4px;
}
.leaflet-control-custom .zoom-buttons {
  text-align: center;
  margin-top: 4px;
}

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media (max-width: 768px) {
  #tiban-search {
    width: 90%;
  }
  .leaflet-control-custom .pan-buttons {
    display: none;
  }
}
</style>
</head>

<body>
<div id="map"></div>
<div id="title">ã‚¬ã‚¹ç®¡æ¤œç´¢ãƒãƒƒãƒ—</div>

<div id="legend">
  <h4>å‡¡ä¾‹</h4>
  <div><span style="background:#ff0000"></span> ä¸­åœ§ã‚¬ã‚¹ç®¡</div>
  <div><span style="background:#008000"></span> ä½åœ§ã‚¬ã‚¹ç®¡</div>
  <div><span style="background:#ffff00"></span> ä¾›çµ¦å¯èƒ½ç¯„å›²</div>
  <div><span style="background:#000000"></span> ç”ºä¼šç¯„å›²</div>
</div>

<div id="tiban-search">
  <input type="text" id="tiban-input" placeholder="æ¤œç´¢ï¼ˆåœ°åŒºåã‚’å…¥åŠ›ã€€ä¾‹ï¼šæ¸šï¼‰">
  <ul id="tiban-list"></ul>
</div>

<div id="custom-control" class="leaflet-control-custom">
  <div class="pan-buttons">
    <div><button onclick="map.panBy([0,-100])">â–²</button></div>
    <div><button onclick="map.panBy([-100,0])">â—€</button><button onclick="map.panBy([100,0])">â–¶</button></div>
    <div><button onclick="map.panBy([0,100])">â–¼</button></div>
  </div>
  <div class="zoom-buttons">
    <button onclick="map.zoomIn()">ï¼‹</button><button onclick="map.zoomOut()">ï¼</button>
  </div>
</div>

<script src="js/leaflet.js"></script>
<script src="js/L.Control.Layers.Tree.min.js"></script>
<script src="js/leaflet.rotatedMarker.js"></script>
<script src="js/leaflet.pattern.js"></script>
<script src="js/leaflet-hash.js"></script>
<script src="js/Autolinker.min.js"></script>
<script src="js/rbush.min.js"></script>
<script src="js/labelgun.min.js"></script>
<script src="js/labels.js"></script>
<script src="js/leaflet.photon.js"></script>
<script src="js/qgis2web_expressions.js"></script>

<script src="data/tiku_1.js"></script>
<script src="data/kuiki_2.js"></script>
<script src="data/gas_medium_3.js"></script>
<script src="data/gas_low_4.js"></script>
<script src="js/drawing_list.js"></script>

<script>
// Leaflet ãƒãƒƒãƒ—åˆæœŸåŒ–
var map = L.map('map', { zoomControl:false, maxZoom:20, minZoom:12 }).setView([36.229494,137.958057],15);
var bounds = L.latLngBounds([[36.0975, 137.8317], [36.3273, 138.0962]]);
map.setMaxBounds(bounds);
var hash = new L.Hash(map);
map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');

// ãƒ™ãƒ¼ã‚¹ãƒ¬ã‚¤ãƒ¤ãƒ¼
map.createPane('pane__0');
map.getPane('pane__0').style.zIndex = 400;
var layer__0 = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
    pane: 'pane__0',
    opacity: 1.0,
    minZoom: 4,
    maxZoom: 18
}).addTo(map);

// --- GeoJSON ãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ  ---
function addGeoJSONLayer(data, color, weight, fillColor, fillOpacity, interactive) {
    return L.geoJson(data, {
        style: { color, weight, fillColor, fillOpacity },
        interactive: interactive
    }).addTo(map);
}

// --- ç”ºåã‚¯ãƒªãƒƒã‚¯ï¼šåœ°åŒºå…¨ä½“ã‚¬ã‚¹ç®¡è©³ç´°å›³ï¼ˆPDFï¼‰è¡¨ç¤º ---
function onEachTiku(feature, layer) {
  if (!feature.properties) return;

  const keyCode = String(feature.properties.KEY_CODE);
  const name = feature.properties.S_NAME || '';
  const drawings = (areaDrawingMap[keyCode] || []).slice().sort();

  let popupContent = `
    <div style="font-size:14px;">
      <strong>${name}</strong><br>
      <div style="margin-top:10px;">
  `;

  if (drawings.length === 0) {
    popupContent += 'å¹³é¢å›³ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“';
  } else {

    // 1æšã ã‘ãªã‚‰å³ã‚ªãƒ¼ãƒ—ãƒ³ï¼ˆè©¦é‹è»¢ä¸­ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦ã‚‚OKï¼‰
    /*
    if (drawings.length === 1) {
      window.open(\`pdf/${drawings[0]}.pdf\`, '_blank');
      return;
    }
    */

    drawings.forEach(code => {
      popupContent += `
        <a href="pdf/${code}.pdf" target="_blank"
           style="
             display:block;
             padding:10px;
             margin-bottom:6px;
             background:#f0f0f0;
             border-radius:8px;
             text-align:center;
             text-decoration:none;
             color:#000;
           ">
          ğŸ“„ å¹³é¢å›³ ${code}
        </a>
      `;
    });
  }

  popupContent += `
      </div>
    </div>
  `;

  layer.bindPopup(popupContent, { maxWidth: 260 });
}


// ç”ºä¼šãƒ»ä¾›çµ¦ç¯„å›²
L.geoJson(json_tiku_1, {
    style: {
        color: 'rgba(20,20,20,1.0)',
        weight: 6,
        fillColor: 'rgba(190,178,151,0.1)',
        fillOpacity: 0.1
    },
    onEachFeature: onEachTiku
}).addTo(map);

addGeoJSONLayer(json_kuiki_2, 'rgba(255,232,27,1.0)', 6, null, 0, true);

// ã‚¬ã‚¹ç®¡ãƒ¬ã‚¤ãƒ¤ãƒ¼
function styleGasMedium(feature) {
    var zoom = map.getZoom();
    return { color: 'red', weight: zoom >=17?7:zoom>=15?5:3, fillOpacity:0 };
}
function styleGasLow(feature) {
    var zoom = map.getZoom();
    return { color: 'green', weight: zoom >=17?5:zoom>=15?3:2, fillOpacity:0 };
}
var layerGasMedium = L.geoJson(json_gas_medium_3, { style: styleGasMedium }).addTo(map);
var layerGasLow = L.geoJson(json_gas_low_4, { style: styleGasLow }).addTo(map);
map.on('zoomend', function() {
    layerGasMedium.setStyle(styleGasMedium);
    layerGasLow.setStyle(styleGasLow);
});

// --- ç•ªåœ°æ¤œç´¢ ---
const tibanInput = document.getElementById('tiban-input');
const tibanList = document.getElementById('tiban-list');
let highlightLayer = null;

// æ¤œç´¢ãƒªã‚¹ãƒˆã®é«˜ã•èª¿æ•´ï¼ˆç”»é¢ã‚µã‚¤ã‚ºã¨çµæœæ•°ã«å¿œã˜ã¦ï¼‰
function updateTibanListHeight() {
    const mapHeight = window.innerHeight;
    const maxHeight = mapHeight * 0.5;
    const itemHeight = 36; // li 1å€‹åˆ†ã®é«˜ã•ç›®å®‰
    const numItems = tibanList.children.length;
    const desiredHeight = Math.min(maxHeight, Math.max(itemHeight * numItems, itemHeight));
    tibanList.style.maxHeight = desiredHeight + 'px';
}
window.addEventListener('resize', updateTibanListHeight);

tibanInput.addEventListener('input', function() {
    const val = tibanInput.value.trim();
    tibanList.innerHTML = '';
    if (!val) return;

    const results = json_tiku_1.features.filter(f => ((f.properties.S_NAME||'') + (f.properties.KIHON1||'') + (f.properties.KIHON2||'')).includes(val)).slice(0,20);

    results.forEach(f => {
        const li = document.createElement('li');
        li.textContent = (f.properties.S_NAME||'') + (f.properties.KIHON1||'') + (f.properties.KIHON2||'');
        li.style.cursor='pointer';
        li.style.padding='8px 4px'; 
        li.style.userSelect='none';

        li.addEventListener('click', () => {
            // æ—¢å­˜ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤
            if(highlightLayer) map.removeLayer(highlightLayer);

            // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¿½åŠ ï¼ˆã‚¯ãƒªãƒƒã‚¯ä¸å¯ï¼‰
            highlightLayer = L.geoJson(f, { 
                style: { color:'pink', weight:3, fillOpacity:0.2 },
                interactive: false // â† ã‚¯ãƒªãƒƒã‚¯ã‚’å…ƒãƒãƒªã‚´ãƒ³ã«é€šã™
            }).addTo(map);

            // ãƒãƒƒãƒ—ç§»å‹•
            map.fitBounds(L.geoJson(f).getBounds(), { padding: [50,50] });

            tibanList.innerHTML='';
        });

        tibanList.appendChild(li);
    });

    updateTibanListHeight();
});

// --- ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ‰ãƒ©ãƒƒã‚° ---
const control = document.getElementById('custom-control');
let isDragging = false, dragOffset=[0,0], userPosition=null;

// PC
control.addEventListener('mousedown', e => { isDragging=true; dragOffset=[e.clientX-control.offsetLeft, e.clientY-control.offsetTop]; });
document.addEventListener('mousemove', e => { if(isDragging){ userPosition=[e.clientX-dragOffset[0], e.clientY-dragOffset[1]]; control.style.left=userPosition[0]+'px'; control.style.top=userPosition[1]+'px'; control.style.bottom='auto'; }});
document.addEventListener('mouseup', e => { isDragging=false; });

// ã‚¿ãƒƒãƒ
control.addEventListener('touchstart', e => { isDragging=true; const touch=e.touches[0]; dragOffset=[touch.clientX-control.offsetLeft,touch.clientY-control.offsetTop]; });
document.addEventListener('touchmove', e => { if(isDragging){ const touch=e.touches[0]; userPosition=[touch.clientX-dragOffset[0], touch.clientY-dragOffset[1]]; control.style.left=userPosition[0]+'px'; control.style.top=userPosition[1]+'px'; control.style.bottom='auto'; }});
document.addEventListener('touchend', e => { isDragging=false; });

// ãƒãƒƒãƒ—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»ã‚ºãƒ¼ãƒ ã«é€£å‹•
function updateControlPosition(){
    if(!isDragging && !userPosition){ control.style.left='10px'; control.style.bottom='20px'; control.style.top='auto'; }
    requestAnimationFrame(updateControlPosition);
}
updateControlPosition();
</script>
</body>
</html>
